<wxs module="popup">
var componentInfo = null
var popupInstance = null
var startTop = 0
var currentTop = 0
var distanceTop = 0
function touchstart(event, ownerInstance) {
  var pageY = (event.touches[0] || event.changedTouches[0]).pageY;
  popupInstance = ownerInstance.selectComponent(".popup-box");
  var dataset = event.instance.getDataset()
  componentInfo = dataset.componentInfo;
  startTop = componentInfo.windowH - componentInfo.popupH;
  distanceTop = pageY - startTop;
  currentTop = pageY - distanceTop
  popupInstance.setStyle({
    top: pageY - distanceTop + 'px',
  })
  if (popupInstance.hasClass("popup-transition")) {
    popupInstance.removeClass("popup-transition")
  }
  return false
}

function touchmove(event) {
  var pageY = (event.touches[0] || event.changedTouches[0]).pageY;
  if (currentTop < startTop) return;
  currentTop = pageY;
  popupInstance.setStyle({
    top: pageY - distanceTop + 'px',
    height: componentInfo.popupH + 'px'
  })
  return false
}

function touchend(event, ownerInstance) {
  return handleTouch(event, ownerInstance)
}

function touchcancel(event, ownerInstance) {
  return handleTouch(event, ownerInstance)
}

function handleTouch(event, ownerInstance) {
  var ph = componentInfo.popupH;
  popupInstance.addClass("popup-transition")
  if (currentTop - startTop < ph * 1 / 4) {
    popupInstance.setStyle({
      top: startTop + 'px',
      height: componentInfo.popupH + 'px'
    })

    ownerInstance.callMethod('handlePopup', {show: true});
  } else {
    closePopup(event, ownerInstance)
  }
  return false
}

function closePopup(event, ownerInstance) {
  if (!popupInstance) {
    popupInstance = ownerInstance.selectComponent(".popup-box");
    var dataset = event.instance.getDataset()
    componentInfo = dataset.componentInfo;
  }

  popupInstance.setStyle({
    top: "",
    height: componentInfo.popupH + 'px',
  })
  ownerInstance.callMethod("handlePopup", {show: false})
}

module.exports = {
  touchstart: touchstart,
  touchmove: touchmove,
  touchend: touchend,
  touchcancel: touchcancel,
  closePopup: closePopup,
}
</wxs>
<view class="popup-container data-v-0d4a68c2"><block wx:if="{{showPopup}}"><view class="{{['data-v-0d4a68c2','mask','z-index-'+zIndex]}}" catchtouchmove="{{true}}" data-component-info="{{componentInfo}}" bindtap="{{popup.closePopup}}"></view></block><view class="{{['data-v-0d4a68c2','popup-box popup-transition']}}" style="{{'top:'+(top+'px')+';'+('height:'+(height+'rpx')+';')+('z-index:'+(zIndex)+';')}}" catchtouchmove="{{true}}"><view class="move-btn flex row data-v-0d4a68c2" style="{{'pointer-events:'+(showPopup?'auto':'none')+';'}}" data-component-info="{{componentInfo}}" id="popup-move-btn" bindtouchstart="{{popup.touchstart}}" bindtouchmove="{{popup.touchmove}}" bindtouchend="{{popup.touchend}}"><view class="line data-v-0d4a68c2"></view></view><slot></slot></view></view>